<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/public/img/tab_logo.png" type="image/png">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="public/css/style.css">
    <script src="public/js/ui.js" type="module" defer></script>
</head>

<body>
    <div id="wrapper">
        <header>
            <a href="index.html"><img id="headerLogo" src="./public/img/logo.jpg" alt="logo"/></a>         
            <div class="tabsDiv" id="tabsDiv">
                <button class="tabs tabSelected" id="recipesTab">Recipes</button>
                <button class="tabs" id="messagesTab">Messages</button>
                <button class="tabs" id="usersTab">Users</button>
            </div>
            <nav>
                <div id="nav">
                    <button id="homeButton" onclick="location.href='./index.html'"></button>
                    <button>Register</button>
                    <button>Login</button>
                    <button onclick="location.href='/adminPage.html'">Admin Page</button>
                </div>
                <div id="searchDiv">
                    <form id="searchForm" action="/search" method="GET">
                        <input type="search" name="query" id="search-box" placeholder="Search...">
                        <button id="searchButton" type="submit"></button>
                    </form>
                </div>
            </nav>
        </header>
        <main>
            <div id="recipesSection" class="contentSection">
                <div class="container">
                    <div class="search-filter">
                        <input type="text" id="recipeSearchBox" placeholder="Search recipes...">
                        <div class="filter-group">
                            <select id="recipeCategoryFilter">
                                <option value="">All Categories</option>
                                <option value="Indian">Indian</option>
                                <option value="Chinese">Chinese</option>
                                <option value="Italian">Italian</option>
                                <option value="French">French</option>
                                <option value="Russian">Russian</option>
                                <option value="Moldovan">Moldovan</option>
                            </select>
                            <select id="recipeComplexityFilter">
                                <option value="">All Complexities</option>
                                <option value="1">Very Easy</option>
                                <option value="2">Easy</option>
                                <option value="3">Medium</option>
                                <option value="4">Hard</option>
                                <option value="5">Very Hard</option>
                            </select>
                            <select id="recipeRatingFilter">
                                <option value="">All Ratings</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                            <select id="recipePrepTimeFilter">
                                <option value="">All Prep Times</option>
                                <option value="30">Up to 30 mins</option>
                                <option value="60">Up to 1 hour</option>
                                <option value="120">Up to 2 hours</option>
                                <option value="240">Up to 4 hours</option>
                                <option value="300">Over 4 hours</option>
                            </select>
                        </div>
                    </div>
                    <button class="button" id="toggleFormButton">+ Add Recipe</button>
                    <div class="addRecipe" id="addRecipeForm" style="display: none;">
                        <h2>Add New Recipe</h2>
                        <div class="form-group">
                            <label for="dishName">Dish Name:</label>
                            <input type="text" id="dishName" placeholder="Dish name here">
                        </div>
                        <div class="form-group">
                            <label for="dishDescription">Dish Description:</label>
                            <input type="text" id="dishDescription" placeholder="Dish description here">
                        </div>
                        <div class="form-group">
                            <label for="dishIngredients">Dish Ingredients:</label>
                            <input type="text" id="dishIngredients" placeholder="Dish ingredients here">
                        </div>
                        <div class="form-group">
                            <label for="dishImage">Dish Image:</label>
                            <input type="file" id="dishImage">
                        </div>
                        <div class="form-group">
                            <label for="dishComplexity">Dish Complexity:</label>
                            <select id="dishComplexity">
                                <option value="1">Very Easy</option>
                                <option value="2">Easy</option>
                                <option value="3">Medium</option>
                                <option value="4">Hard</option>
                                <option value="5">Very Hard</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dishPrepTime">Dish Prep Time:</label>
                            <input type="text" id="dishPrepTime" placeholder="Prep time here">
                        </div>
                        <div class="form-group">
                            <label for="dishRating">Dish Rating:</label>
                            <input type="number" id="dishRating" min="1" max="5" step="1" placeholder="Rating (1-5)">
                        </div>
                        <button class="button">+ Add Recipe</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Dish Name</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Ingredients</th>
                                <th>Complexity</th>
                                <th>Prep Time</th>
                                <th>Rating</th>
                                <th>Image</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recipesList">
                            <!-- Recipe rows go here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="messagesSection" class="contentSection" style="display: none;">
                <div class="container">
                    <h2>Messages</h2>
                    <div class="search-filter">
                        <input type="text" id="messageSearchBox" placeholder="Search messages...">
                        <select id="messageReadFilter">
                            <option value="">All</option>
                            <option value="read">Read</option>
                            <option value="unread">Unread</option>
                        </select>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Flagged</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Message</th>
                                <th>Date</th>
                                <th>Read</th>
                                <!-- <th>Flag</th> -->
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="messagesList">
                            <!-- Message rows go here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="usersSection" class="contentSection" style="display: none;">
                <div class="container">
                    <div class="search-filter">
                        <input type="text" id="userSearchBox" placeholder="Search users...">
                        <select id="userRoleFilter">
                            <option value="">All Roles</option>
                            <option value="admin">Admin</option>
                            <option value="user">User</option>
                        </select>
                    </div>
                    <button class="button" id="toggleUserFormButton">+ Add User</button>
                    <div class="addUser" id="addUserForm" style="display: none;">
                        <h2>Add New User</h2>
                        <div class="form-group">
                            <label for="userName">Name:</label>
                            <input type="text" id="userName" placeholder="User name here">
                        </div>
                        <div class="form-group">
                            <label for="userEmail">Email:</label>
                            <input type="email" id="userEmail" placeholder="User email here">
                        </div>
                        <div class="form-group">
                            <label for="userPassword">Password:</label>
                            <input type="password" id="userPassword" placeholder="User password here">
                        </div>
                        <div class="form-group">
                            <label for="userRole">Role:</label>
                            <select id="userRole">
                                <option value="admin">Admin</option>
                                <option value="user">User</option>
                            </select>
                        </div>
                        <button class="button">+ Add User</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersList">
                            <!-- User rows go here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
        <footer class="admin-footer">
            <!-- to check why this is not diplayed correctly -->
            <p id="year">&copy;<span id="yearSpan"></span> Your Company. All rights reserved.</p>
            <!-- <p>ahjskdalksdjlkajsdkljaksdjkladjsl</p> -->
        </footer>
    </div>
    <div id="overlay"></div>
    <div class="popup" id="previewRecipePopup">
        <div class="popupHeader">
            <h2>Recipe Preview</h2>
            <button class="closeButton" id="closePreviewPopup">&times;</button>
        </div>
        <div id="previewRecipeContent">
            <!-- Preview content goes here -->
        </div>
    </div>
    <div class="popup" id="editRecipePopup">
        <div class="popupHeader">
            <h2>Edit Recipe</h2>
            <button class="closeButton" id="closeEditPopup">&times;</button>
        </div>
        <div id="editRecipeContent">
            <!-- Edit form goes here -->
            <div class="form-group">
                <label for="editDishName">Dish Name:</label>
                <input type="text" id="editDishName" placeholder="Dish name here">
            </div>
            <div class="form-group">
                <label for="editDishDescription">Dish Description:</label>
                <input type="text" id="editDishDescription" placeholder="Dish description here">
            </div>
            <div class="form-group">
                <label for="editDishIngredients">Dish Ingredients:</label>
                <input type="text" id="editDishIngredients" placeholder="Dish ingredients here">
            </div>
            <div class="form-group">
                <label for="editDishImage">Dish Image:</label>
                <input type="file" id="editDishImage">
            </div>
            <div class="form-group">
                <label for="editDishComplexity">Dish Complexity:</label>
                <select id="editDishComplexity">
                    <option value="1">Very Easy</option>
                    <option value="2">Easy</option>
                    <option value="3">Medium</option>
                    <option value="4">Hard</option>
                    <option value="5">Very Hard</option>
                </select>
            </div>
            <div class="form-group">
                <label for="editDishPrepTime">Dish Prep Time:</label>
                <input type="text" id="editDishPrepTime" placeholder="Prep time here">
            </div>
            <div class="form-group">
                <label for="editDishRating">Dish Rating:</label>
                <input type="number" id="editDishRating" min="1" max="5" step="1" placeholder="Rating (1-5)">
            </div>
            <button class="button" id="saveEditButton">Save Changes</button>
        </div>
    </div>
    <div class="popup" id="viewMessagePopup">
        <div class="popupHeader">
            <h2>Message Details</h2>
            <button class="closeButton" id="closeViewMessagePopup">&times;</button>
        </div>
        <div id="viewMessageContent">
            <!-- Message details go here -->
        </div>
    </div>
    <div class="popup" id="editUserPopup">
        <div class="popupHeader">
            <h2>Edit User</h2>
            <button class="closeButton" id="closeEditUserPopup">&times;</button>
        </div>
        <div id="editUserContent">
            <!-- Edit form goes here -->
            <div class="form-group">
                <label for="editUserName">Name:</label>
                <input type="text" id="editUserName" placeholder="User name here">
            </div>
            <div class="form-group">
                <label for="editUserEmail">Email:</label>
                <input type="email" id="editUserEmail" placeholder="User email here">
            </div>
            <div class="form-group">
                <label for="editUserPassword">Password:</label>
                <input type="password" id="editUserPassword" placeholder="User password here">
            </div>
            <div class="form-group">
                <label for="editUserRole">Role:</label>
                <select id="editUserRole">
                    <option value="admin">Admin</option>
                    <option value="user">User</option>
                </select>
            </div>
            <button class="button" id="saveUserChangesButton">Save Changes</button>
        </div>
    </div>
<!-- not sure what this does//////////to check////////////////////////////////////////// -->
    <div class="popup" id="confirmActionPopup">
        <div class="popupHeader">
            <h2>Confirm Action</h2>
            <button class="closeButton" id="closeConfirmActionPopup">&times;</button>
        </div>
        <div id="confirmActionContent">
            <!-- Confirmation message goes here -->
            <p id="confirmActionMessage">Are you sure?</p>
            <div class="actions">
                <button id="confirmActionYesButton" class="button">Yes</button>
                <button id="confirmActionNoButton" class="button">No</button>
            </div>
        </div>
    </div>
    <!-- \\\\\\\\\\\\//////////////////to remove the below when add/edit recipe is ready -->
    <div class="contentSection">
        <h2>Upload Image</h2>
        <input type="file" id="imageInput" accept="image/*">
        <button id="uploadButton">Upload Image</button>
    </div>










<!-- to sort out the scripts and move the to js fiels-->



    <script>
        // Tabs functionality for Admin Page
        const tabButtonArray = document.querySelectorAll('.tabs');
        const contentSections = document.querySelectorAll('.contentSection');

        tabButtonArray.forEach((tabButton, index) => {
            tabButton.addEventListener('click', () => {
                document.querySelector('.tabSelected')?.classList.remove('tabSelected');
                tabButton.classList.add('tabSelected');
                contentSections.forEach((section, sectionIndex) => {
                    section.style.display = sectionIndex === index ? 'block' : 'none';
                });
            });
        });








        // Function to preview recipe
        function previewRecipe(recipe) {
            console.log("preview recipe function called");

            const previewPopup = document.getElementById('previewRecipePopup');
            const overlay = document.getElementById('overlay');
            const previewContent = document.getElementById('previewRecipeContent');

            previewContent.innerHTML = `
                <h3>${recipe.name}</h3>
                <p><strong>Description:</strong> ${recipe.description}</p>
                <p><strong>Ingredients:</strong> ${recipe.ingredients.join(', ')}</p>
                <p><strong>Complexity:</strong> ${recipe.complexity}</p>
                <p><strong>Prep Time:</strong> ${recipe.prepTime}</p>
                <p><strong>Rating:</strong> ${recipe.rating}</p>
                <img src="${recipe.image}" alt="Dish Image" style="width: 100%;">
            `;

            previewPopup.classList.add('active');
            overlay.classList.add('active');
        }

        // Function to edit recipe
        function editRecipe(recipe) {
            const editPopup = document.getElementById('editRecipePopup');
            const overlay = document.getElementById('overlay');
            document.getElementById('editDishName').value = recipe.name;
            document.getElementById('editDishDescription').value = recipe.description;
            document.getElementById('editDishIngredients').value = recipe.ingredients.join(', ');
            document.getElementById('editDishComplexity').value = recipe.complexity;
            document.getElementById('editDishPrepTime').value = recipe.prepTime;
            document.getElementById('editDishRating').value = recipe.rating;

            editPopup.classList.add('active');
            overlay.classList.add('active');
        }


        // Function to edit user
        function editUser(user) {
            const editUserPopup = document.getElementById('editUserPopup');
            const overlay = document.getElementById('overlay');
            document.getElementById('editUserName').value = user.name;
            document.getElementById('editUserEmail').value = user.email;
            document.getElementById('editUserPassword').value = ''; // Do not prefill password
            document.getElementById('editUserRole').value = user.role;

            editUserPopup.classList.add('active');
            overlay.classList.add('active');
        }

        // Function to show confirmation popup
        function confirmAction(message, action, id) {
            const confirmPopup = document.getElementById('confirmActionPopup');
            const overlay = document.getElementById('overlay');
            const confirmMessage = document.getElementById('confirmActionMessage');
            const yesButton = document.getElementById('confirmActionYesButton');

            confirmMessage.textContent = message;
            yesButton.onclick = function () {
                if (action === 'disableUser') {
                    disableUser(id);
                } else if (action === 'unlockUser') {
                    unlockUser(id);
                } else if (action === 'deleteUser') {
                    deleteUser(id);
                } else if (action === 'deleteRecipe') {
                    deleteRecipe(id);
                } else if (action === 'deleteMessage') {
                    deleteMessage(id);
                } else if (action === 'resetPassword') {
                    resetPassword(id);
                }
                confirmPopup.classList.remove('active');
                overlay.classList.remove('active');
            };

            confirmPopup.classList.add('active');
            overlay.classList.add('active');
        }

        // Function to close popups
        document.getElementById('closePreviewPopup').addEventListener('click', () => {
            document.getElementById('previewRecipePopup').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        });

        document.getElementById('closeEditPopup').addEventListener('click', () => {
            document.getElementById('editRecipePopup').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        });

        document.getElementById('closeViewMessagePopup').addEventListener('click', () => {
            document.getElementById('viewMessagePopup').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        });

        document.getElementById('closeEditUserPopup').addEventListener('click', () => {
            document.getElementById('editUserPopup').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        });

        document.getElementById('closeConfirmActionPopup').addEventListener('click', () => {
            document.getElementById('confirmActionPopup').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        });

        document.getElementById('confirmActionNoButton').addEventListener('click', () => {
            document.getElementById('confirmActionPopup').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        });

        // // Sample data for testing
        // const sampleRecipes = [
        //     {
        //         id: 1,
        //         name: 'Butter Chicken',
        //         description: 'A creamy and delicious butter chicken.',
        //         category: 'Indian',
        //         ingredients: ['chicken', 'butter', 'cream', 'tomato puree'],
        //         complexity: 'Medium',
        //         prepTime: '60 mins',
        //         rating: 4,
        //         image: 'path/to/image.jpg'
        //     }
        // ];

        // const sampleMessages = [
        //     {
        //         id: 1,
        //         name: 'John Doe',
        //         email: 'john.doe@example.com',
        //         content: 'Hello, I have a question...',
        //         date: '2023-05-15',
        //         read: false,
        //         flagged: false
        //     }
        // ];

        // const sampleUsers = [
        //     {
        //         id: 1,
        //         name: 'Admin User',
        //         email: 'admin@example.com',
        //         role: 'admin'
        //     },
        //     {
        //         id: 2,
        //         name: 'Regular User',
        //         email: 'user@example.com',
        //         role: 'user'
        //     }
        // ];

        // // Adding sample data to tables for testing
        // sampleRecipes.forEach(addRecipeRow);

        // sampleUsers.forEach(addUserRow);

        // Search and filter functionality for recipes
        const recipeSearchBox = document.getElementById('recipeSearchBox');
        const recipeCategoryFilter = document.getElementById('recipeCategoryFilter');
        const recipeComplexityFilter = document.getElementById('recipeComplexityFilter');
        const recipeRatingFilter = document.getElementById('recipeRatingFilter');
        const recipePrepTimeFilter = document.getElementById('recipePrepTimeFilter');

        recipeSearchBox.addEventListener('input', filterRecipes);
        recipeCategoryFilter.addEventListener('change', filterRecipes);
        recipeComplexityFilter.addEventListener('change', filterRecipes);
        recipeRatingFilter.addEventListener('change', filterRecipes);
        recipePrepTimeFilter.addEventListener('change', filterRecipes);

        function filterRecipes() {
            const searchText = recipeSearchBox.value.toLowerCase();
            const filterCategory = recipeCategoryFilter.value;
            const filterComplexity = recipeComplexityFilter.value;
            const filterRating = recipeRatingFilter.value;
            const filterPrepTime = recipePrepTimeFilter.value;

            const filteredRecipes = sampleRecipes.filter((recipe) => {
                const matchesSearchText = recipe.name.toLowerCase().includes(searchText);
                const matchesCategory = filterCategory === '' || recipe.category === filterCategory;
                const matchesComplexity = filterComplexity === '' || recipe.complexity === filterComplexity;
                const matchesRating = filterRating === '' || recipe.rating == filterRating;
                const matchesPrepTime = filterPrepTime === '' || recipe.prepTime <= filterPrepTime;

                return matchesSearchText && matchesCategory && matchesComplexity && matchesRating && matchesPrepTime;
            });

            document.getElementById('recipesList').innerHTML = '';
            filteredRecipes.forEach(addRecipeRow);
        }

        // Search functionality for messages
        const messageSearchBox = document.getElementById('messageSearchBox');
        const messageReadFilter = document.getElementById('messageReadFilter');

        messageSearchBox.addEventListener('input', filterMessages);
        messageReadFilter.addEventListener('change', filterMessages);

        function filterMessages() {
            const searchText = messageSearchBox.value.toLowerCase();
            const filterRead = messageReadFilter.value;

            const filteredMessages = sampleMessages.filter((message) => {
                const matchesSearchText = message.name.toLowerCase().includes(searchText) ||
                    message.email.toLowerCase().includes(searchText) ||
                    message.content.toLowerCase().includes(searchText);
                const matchesRead = filterRead === '' || (filterRead === 'read' && message.read) || (filterRead === 'unread' && !message.read);

                return matchesSearchText && matchesRead;
            });

            document.getElementById('messagesList').innerHTML = '';
            filteredMessages.forEach(addMessageRow);
        }

        // Search and filter functionality for users
        const userSearchBox = document.getElementById('userSearchBox');
        const userRoleFilter = document.getElementById('userRoleFilter');

        userSearchBox.addEventListener('input', filterUsers);
        userRoleFilter.addEventListener('change', filterUsers);

        function filterUsers() {
            const searchText = userSearchBox.value.toLowerCase();
            const filterRole = userRoleFilter.value;

            const filteredUsers = sampleUsers.filter((user) => {
                const matchesSearchText = user.name.toLowerCase().includes(searchText) ||
                    user.email.toLowerCase().includes(searchText);
                const matchesRole = filterRole === '' || user.role === filterRole;

                return matchesSearchText && matchesRole;
            });

            document.getElementById('usersList').innerHTML = '';
            filteredUsers.forEach(addUserRow);
        }


        // const todelete= document.getElementById('todelete');
        // todelete.addEventListener('click', ()=>{
        //     insertImage();
        // })


        document.addEventListener('DOMContentLoaded', () => {
            const uploadButton = document.getElementById('uploadButton');
            const fileInput = document.getElementById('imageInput');

            if (uploadButton && fileInput) {
                uploadButton.addEventListener('click', () => {
                    if (fileInput.files.length > 0) {
                        const file = fileInput.files[0];
                        insertImage(file);
                    } else {
                        alert('Please select a file.');
                    }
                });
            } else {
                console.error('Upload button or file input not found.');
            }
        });


        //this hould go into logic folder
        async function insertImage(file) {
            try {
                const reader = new FileReader();

                reader.onloadend = async function () {
                    const base64Image = reader.result.split(',')[1];

                    // Prepare the data to be sent as JSON
                    const data = {
                        "function": "insertImage",
                        "image": base64Image
                    };

                    // Send the data to the server
                    const response = await fetch("http://localhost/data/index.php", {
                        method: "POST",
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    // Check if the response is OK
                    if (!response.ok) {
                        console.error('Error response from server:', response.status, response.statusText);
                        return;
                    }

                    const textResponse = await response.text();
                    console.log('Raw server response:', textResponse);

                    // Try parsing the response as JSON
                    let jsonResponse;
                    try {
                        jsonResponse = JSON.parse(textResponse);
                    } catch (e) {
                        console.error('Error parsing JSON response:', e);
                        console.error('Received response:', textResponse); // Log the received response
                        return;
                    }

                    console.log('Parsed JSON response:', jsonResponse);

                    if (jsonResponse.status === "success") {
                        console.log('Image uploaded successfully:', jsonResponse);
                    } else {
                        console.error('Error uploading image:', jsonResponse);
                    }
                };

                reader.onerror = function (error) {
                    console.error('Error reading file:', error);
                };

                reader.readAsDataURL(file);
            } catch (error) {
                console.log("Error uploading image:", error);
            }
        }




    </script>    
</body>

</html>